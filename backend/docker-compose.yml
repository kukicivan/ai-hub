services:
  # PHP Laravel Application
  backend_app:
    user: www-data
    build:
      context: ./.docker/php
      args:
        - PHP_VERSION=8.3
        - UID=${UID:-1000}
        - GID=${GID:-1000}
    container_name: backend_app
    restart: unless-stopped
    working_dir: /var/www
    environment:
      - TZ=UTC
    volumes:
      - ./src:/var/www
    networks:
      - backend_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      backend_db:
        condition: service_healthy
      backend_redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "exit 0" ]
      interval: 10s
      retries: 1

  # Nginx Web Server
  backend_nginx:
    image: nginx:stable-alpine
    container_name: backend_nginx
    restart: unless-stopped
    ports:
      - "9001:80"
      - "9444:443"
    volumes:
      - ./src:/var/www
      - ./.docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./certs:/etc/nginx/certs:ro
    networks:
      - backend_network
    depends_on:
      backend_app:
        condition: service_healthy

  # MySQL Database
  backend_db:
    image: mysql:8.0
    container_name: backend_db
    restart: unless-stopped
    command: --default-time-zone=+00:00
    environment:
      MYSQL_DATABASE: backend_laravel
      MYSQL_USER: backend_admin
      MYSQL_PASSWORD: backend_pass_2025
      MYSQL_ROOT_PASSWORD: root_backend_2025
      TZ: UTC
    volumes:
      - backend_mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - backend_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "backend_admin", "--password=backend_pass_2025"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis Cache & Sessions
  backend_redis:
    image: redis:alpine
    container_name: backend_redis
    restart: unless-stopped
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - backend_redis_data:/data
      - ./.docker/redis/redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - "6379:6379"
    networks:
      - backend_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Database Migrations & Seeds
  backend_migrations:
    build:
      context: ./.docker/php
      args:
        - PHP_VERSION=8.3
        - UID=${UID:-1000}
        - GID=${GID:-1000}
    container_name: backend_migrations
    working_dir: /var/www
    volumes:
      - ./src:/var/www
    networks:
      - backend_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      backend_db:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Waiting for database to be ready...'
        sleep 10
        php artisan key:generate
        php artisan migrate --force
        php artisan db:seed --force
        php artisan storage:link
        php artisan config:cache
        echo 'Setup completed successfully!'
      "
    restart: "no"

  # Laravel Scheduler (Cron Alternative)
#  backend_scheduler:
#    user: www-data
#    build:
#      context: ./.docker/php
#      args:
#        - PHP_VERSION=8.3
#        - UID=${UID:-1000}
#        - GID=${GID:-1000}
#    container_name: backend_scheduler
#    restart: unless-stopped
#    working_dir: /var/www
#    environment:
#      - TZ=UTC
#    volumes:
#      - ./src:/var/www
#    networks:
#      - backend_network
#    extra_hosts:
#      - "host.docker.internal:host-gateway"
#    depends_on:
#      backend_app:
#        condition: service_healthy
#      backend_db:
#        condition: service_healthy
#      backend_redis:
#        condition: service_healthy
#    command: >
#      sh -c "
#        echo 'ðŸ• Laravel Scheduler Starting...'
#        echo 'ðŸ“… Timezone: UTC'
#        echo 'â° Running schedule:run every 60 seconds'
#        echo 'ðŸ“Š Logs: /var/www/storage/logs/scheduler/'
#        echo '----------------------------------------'
#        while true; do
#          echo \"[$(date '+%Y-%m-%d %H:%M:%S')] Running scheduled tasks...\"
#          php artisan schedule:run --verbose --no-interaction 2>&1 | tee -a /var/www/storage/logs/scheduler/scheduler.log
#          sleep 60
#        done
#      "
#    healthcheck:
#      test: [ "CMD-SHELL", "pgrep -f 'php artisan schedule:run' || exit 1" ]
#      interval: 120s
#      timeout: 10s
#      retries: 3

  # Laravel Queue Worker (Optional - for async jobs)
#  backend_queue:
#    user: www-data
#    build:
#      context: ./.docker/php
#      args:
#        - PHP_VERSION=8.3
#        - UID=${UID:-1000}
#        - GID=${GID:-1000}
#    container_name: backend_queue
#    restart: unless-stopped
#    working_dir: /var/www
#    environment:
#      - TZ=UTC
#    volumes:
#      - ./src:/var/www
#    networks:
#      - backend_network
#    extra_hosts:
#      - "host.docker.internal:host-gateway"
#    depends_on:
#      backend_app:
#        condition: service_healthy
#      backend_db:
#        condition: service_healthy
#      backend_redis:
#        condition: service_healthy
#    command: >
#      sh -c "
#        echo 'ðŸ”„ Laravel Queue Worker Starting...'
#        echo 'ðŸ“Š Connection: database'
#        php artisan queue:work database --sleep=3 --tries=3 --max-time=3600 --verbose
#      "
#    healthcheck:
#      test: [ "CMD-SHELL", "pgrep -f 'artisan queue:work' || exit 1" ]
#      interval: 60s
#      timeout: 10s
#      retries: 3

networks:
  backend_network:
    driver: bridge

volumes:
  backend_mysql_data:
    driver: local
  backend_redis_data:
    driver: local